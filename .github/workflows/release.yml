name: Auto Release on Version Change

on:
  push:
    branches: [master]
    tags-ignore:
      - '**'

jobs:
  check-version-and-release:
    name: æ£€æŸ¥ç‰ˆæœ¬å˜åŒ–å¹¶å‘å¸ƒ
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions@github.com"
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      - name: Get current version from package.json
        id: current-version
        run: |
          current_version=$(jq -r '.version' package.json)
          echo "version=$current_version" >> $GITHUB_OUTPUT
          echo "ðŸ” å½“å‰ package.json ç‰ˆæœ¬: $current_version"

      - name: Get latest tag version
        id: latest-tag
        run: |
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "0.0.0")
          echo "version=$latest_tag" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ ä»“åº“æœ€æ–°æ ‡ç­¾ç‰ˆæœ¬: $latest_tag"

      - name: Compare versions
        id: version-check
        run: |
          current="${{ steps.current-version.outputs.version }}"
          latest="${{ steps.latest-tag.outputs.version }}"

          echo "å½“å‰ç‰ˆæœ¬: $current"
          echo "æœ€æ–°æ ‡ç­¾: $latest"

          if [ "$current" != "$latest" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… ç‰ˆæœ¬å·²å‘ç”Ÿå˜åŒ–ï¼Œå°†åˆ›å»ºæ–°çš„å‘å¸ƒ"
            echo "new_tag=v$current" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ç‰ˆæœ¬æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡å‘å¸ƒæµç¨‹"
          fi

      - name: Generate changelog
        if: steps.version-check.outputs.changed == 'true'
        id: changelog
        run: |
          npm install -g conventional-changelog-cli

          if [ "${{ steps.latest-tag.outputs.version }}" == "0.0.0" ]; then
            changelog=$(conventional-changelog -p angular)
          else
            changelog=$(conventional-changelog -p angular --from v${{ steps.latest-tag.outputs.version }})
          fi

          if [ -z "$changelog" ]; then
            cat > changelog.md << 'EOF'
          ### ðŸš€ ç‰ˆæœ¬ ${{ steps.current-version.outputs.version }}

          - ç‰ˆæœ¬æ›´æ–°è‡³ ${{ steps.current-version.outputs.version }}
          - è¯¦ç»†æ›´æ”¹è¯·æŸ¥çœ‹æäº¤åŽ†å²
          EOF
          else
            echo "$changelog" > changelog.md
          fi

          echo "generated=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ Changelog å·²ç”Ÿæˆ"

      - name: Create Git tag
        if: steps.version-check.outputs.changed == 'true'
        run: |
          tag_name="${{ steps.version-check.outputs.new_tag }}"
          echo "ðŸ·ï¸ åˆ›å»ºæ ‡ç­¾: $tag_name"

          # è®¾ç½®è¿œç¨‹ URL ä½¿ç”¨ token è®¤è¯
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

          git tag -a "$tag_name" -m "Release $tag_name"
          git push origin "$tag_name"

          echo "âœ… æ ‡ç­¾ $tag_name å·²åˆ›å»ºå¹¶æŽ¨é€"

      - name: Create GitHub Release
        if: steps.version-check.outputs.changed == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version-check.outputs.new_tag }}
          release_name: Release ${{ steps.version-check.outputs.new_tag }}
          body_path: changelog.md
          draft: false
          prerelease: false

      - name: Install root dependencies
        if: steps.version-check.outputs.changed == 'true'
        run: |
          echo "ðŸ“¦ å®‰è£…æ ¹ç›®å½•ä¾èµ–..."
          npm install

      - name: Install package dependencies
        if: steps.version-check.outputs.changed == 'true'
        working-directory: packages/element-ui-x
        run: |
          echo "ðŸ“¦ å®‰è£…ç»„ä»¶åº“ä¾èµ–..."
          npm install

      - name: Build component library
        if: steps.version-check.outputs.changed == 'true'
        working-directory: packages/element-ui-x
        run: |
          echo "ðŸ”¨ æž„å»ºç»„ä»¶åº“..."
          npm run build

      - name: Configure npm authentication
        if: steps.version-check.outputs.changed == 'true'
        working-directory: packages/element-ui-x
        run: |
          echo "ðŸ”‘ é…ç½® npm è®¤è¯..."
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        if: steps.version-check.outputs.changed == 'true'
        id: npm-publish
        working-directory: packages/element-ui-x
        run: |
          echo "ðŸš€ å‘å¸ƒåˆ° npm..."
          npm publish --access public
          echo "success=true" >> $GITHUB_OUTPUT
          echo "âœ… åŒ…å·²æˆåŠŸå‘å¸ƒåˆ° npm"
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

      - name: Output npm publish status
        if: steps.version-check.outputs.changed == 'true'
        run: |
          if [ "${{ steps.npm-publish.outputs.success }}" == "true" ]; then
            echo "âœ… npm å‘å¸ƒæˆåŠŸ!"
            echo "åŒ…å: vue-element-ui-x"
            echo "ç‰ˆæœ¬: ${{ steps.current-version.outputs.version }}"
            echo "npm åœ°å€: https://www.npmjs.com/package/vue-element-ui-x"
          else
            echo "âŒ npm å‘å¸ƒå¤±è´¥"
            echo "è¯·æ£€æŸ¥ NPM_TOKEN é…ç½®æˆ–æ‰‹åŠ¨å‘å¸ƒ"
          fi

      - name: Output release info
        if: steps.version-check.outputs.changed == 'true'
        run: |
          echo "ðŸŽ‰ å‘å¸ƒå®Œæˆ!"
          echo "ç‰ˆæœ¬: ${{ steps.current-version.outputs.version }}"
          echo "æ ‡ç­¾: ${{ steps.version-check.outputs.new_tag }}"
          echo "Release åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version-check.outputs.new_tag }}"

      - name: Summary
        run: |
          if [ "${{ steps.version-check.outputs.changed }}" == "true" ]; then
            echo "âœ… è‡ªåŠ¨å‘å¸ƒæµç¨‹å·²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "- æ–°ç‰ˆæœ¬: ${{ steps.current-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- æ ‡ç­¾: ${{ steps.version-check.outputs.new_tag }}" >> $GITHUB_STEP_SUMMARY
            echo "- [æŸ¥çœ‹ Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version-check.outputs.new_tag }})" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.npm-publish.outputs.success }}" == "true" ]; then
              echo "- âœ… [npm åŒ…å·²å‘å¸ƒ](https://www.npmjs.com/package/vue-element-ui-x)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âŒ npm å‘å¸ƒå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ ç‰ˆæœ¬æœªå˜åŒ–ï¼Œæœªæ‰§è¡Œå‘å¸ƒæ“ä½œ" >> $GITHUB_STEP_SUMMARY
            echo "- å½“å‰ç‰ˆæœ¬: ${{ steps.current-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          fi
